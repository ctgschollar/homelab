version: "3.8"

services:
  coredns:
    image: coredns/coredns:latest
    command: ["-conf", "/etc/coredns/Corefile"]
    configs:
      - source: coredns_corefile
        target: /etc/coredns/Corefile
        mode: 0444
      - source: coredns_home_db
        target: /etc/coredns/zones/home.db
        mode: 0444
      - source: coredns_schollar_dev_db
        target: /etc/coredns/zones/schollar.dev.db
        mode: 0444
    ports:
      - target: 53
        published: 53
        protocol: udp
        mode: host
      - target: 53
        published: 53
        protocol: tcp
        mode: host
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 0
      placement:
        constraints:
          - node.role == manager
    networks:
      - dns-net

networks:
  dns-net:
    driver: overlay
    attachable: true

configs:
  coredns_corefile:
    name: coredns_corefile              # stable name (no manual versioning)
    file: ./Corefile
  coredns_home_db:
    name: coredns_home_db               # stable name
    file: ./zones/home.db
  coredns_schollar_dev_db:
    name: coredns_schollar_dev_db       # stable name
    file: ./zones/schollar.dev.db
