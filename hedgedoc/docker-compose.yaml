version: "3.8"

services:
  hedgedoc:
    image: quay.io/hedgedoc/hedgedoc:1.9.9
    environment:
      # --- HedgeDoc behind Traefik (SSL terminates at Traefik) ---
      CMD_DOMAIN: "hdoc.schollar.dev"
      CMD_URL_ADDPORT: "false"
      CMD_PROTOCOL_USESSL: "true"   # Traefik forwards X-Forwarded-Proto=https

      # --- DB (already running) ---
      CMD_DB_DIALECT: "postgres"
      CMD_DB_HOST: "pg.schollar.dev"
      CMD_DB_PORT: "5432"
      CMD_DB_DATABASE: "hedgedoc"
      CMD_DB_USERNAME: "hedgedoc"
      CMD_DB_PASSWORD: "u08I8jYTw@0JQJ3p"
      CMD_SESSION_SECRET: "p91rXXA3ss5SMVlrwR5Xvm7VE0tLFygSTm0uagdQKMCMSg8mCNGvXehkQh2RENSv"

      # --- Security / sessions ---
      NODE_ENV: "production"

      # --- Uploads stored on volume ---
      CMD_IMAGE_UPLOAD_TYPE: "filesystem"
    
    secrets:
      - cmd_pg_password
      - hedgedoc_session_secret

    volumes:
      - hedgedoc-uploads:/hedgedoc/public/uploads

    deploy:
      replicas: 1
      placement:
        constraints:
          - "node.labels.linstor==true"
      labels:
        # ===========================
        # Traefik (HTTPS router)
        # ===========================
        traefik.enable: "true"
        traefik.docker.network: traefik-net
        traefik.http.routers.hedgedoc.rule: "Host(`hdoc.schollar.dev`)"
        traefik.http.routers.hedgedoc.entrypoints: "websecure"
        traefik.http.routers.hedgedoc.tls.certresolver: cf
        traefik.http.services.hedgedoc.loadbalancer.server.port: "3000"
        # (Optional) HSTS/headers via middleware:
        # traefik.http.middlewares.hd-sec.headers.stsSeconds: "31536000"
        # traefik.http.routers.hedgedoc.middlewares: "hd-sec"

        # ===========================
        # Prometheus Blackbox labels
        # (consumed by the job below)
        # ===========================
        # Mark this service to be probed by blackbox
        prometheus.blackbox: "true"
        metrics.probe_url: "https://hdoc.schollar.dev"

volumes:
  hedgedoc-uploads:
    driver: linbit/linstor-docker-volume
    driver_opts:
      size: "10G"
      fs: "xfs"
      replicas: "2"           # 2-way replication on SSD pool
      storagepool: "pool_ssd" # your LINSTOR SSD pool

secrets:
  cmd_pg_password:
    external: true
  hedgedoc_session_secret:
    external: true