version: "3.8"

configs:
  homepage_settings:
    name: homepage_settings
    file: ./settings.yaml
  homepage_services:
    name: homepage_services
    file: ./services.yaml
  homepage_docker:
    name: homepage_docker
    file: ./docker.yaml

networks:
  traefik-net:
    external: true

services:
  homepage:
    image: ghcr.io/gethomepage/homepage:latest@sha256:ce3389bbd09d6e144088891c8abf532f6fe0b7b70a601ca87053d559d2933f75
    environment:
      HOMEPAGE_ALLOWED_HOSTS: homepage.schollar.dev   # change if you prefer a different host
      TZ: Africa/Johannesburg
    configs:
      - source: homepage_settings
        target: /app/config/settings.yaml
        mode: 0444
      - source: homepage_services
        target: /app/config/services.yaml
        mode: 0444
      - source: homepage_docker
        target: /app/config/docker.yaml
        mode: 0444
    volumes:
      # Mount Docker socket for service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [traefik-net]
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 0
      placement:
        constraints:
          # Must run on manager node to access Docker socket for service discovery
          - node.role == manager
      labels:
        traefik.enable: "true"
        traefik.docker.network: traefik-net

        # HTTPS router
        traefik.http.routers.homepage.rule: Host(`homepage.schollar.dev`)
        traefik.http.routers.homepage.entrypoints: websecure
        traefik.http.routers.homepage.tls.certresolver: cf

        # Upstream service port
        traefik.http.services.homepage.loadbalancer.server.port: "3000"

        # Prometheus Blackbox monitoring
        prometheus.blackbox: "true"
        metrics.probe_url: "https://homepage.schollar.dev"

