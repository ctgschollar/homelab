networks:
  traefik-net:
    external: true

volumes:
  jellyfin_config:
    driver: linbit/linstor-docker-volume
    driver_opts:
      size: "10G"
      fs: "xfs"
      replicas: "2"
      storagepool: "pool_ssd"

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    networks:
      - traefik-net
    volumes:
      - jellyfin_config:/config
      - type: bind
        source: /mnt/shared/jellyfin/cache
        target: /cache
      - type: bind
        source: /mnt/shared/jellyfin/media
        target: /media
    # Optional: publish the external URL Jellyfin should advertise (stream URLs, etc.)
    environment:
      - JELLYFIN_PublishedServerUrl: https://jellyfin.schollar.dev
      - NVIDIA_VISIBLE_DEVICES: all
      - NVIDIA_DRIVER_CAPABILITIES: compute,video,utility
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 0
      placement:
        constraints:
          - node.labels.media == true
          - node.labels.gpu == true
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all                 # or 1
              capabilities: [gpu]
      labels:
        traefik.enable: "true"
        traefik.docker.network: traefik-net

        # HTTPS router
        traefik.http.routers.jellyfin.rule: Host(`jellyfin.schollar.dev`)
        traefik.http.routers.jellyfin.entrypoints: websecure
        traefik.http.routers.jellyfin.tls.certresolver: cf

        # Upstream service (Jellyfin listens on 8096 HTTP)
        traefik.http.services.jellyfin.loadbalancer.server.port: "8096"

        # Prometheus Blackbox monitoring
        prometheus.blackbox: "true"
        metrics.probe_url: "https://jellyfin.schollar.dev"