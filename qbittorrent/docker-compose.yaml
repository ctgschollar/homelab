version: "3.8"

services:
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    environment:
      PUID: "0"
      PGID: "0"
      UMASK: "002"
      WEBUI_PORT: "8080"
      # TZ: Africa/Johannesburg
    volumes:
      - qbittorrent_config:/config
      - type: bind
        source: /mnt/shared/torrent/complete                     # ← completed downloads
        target: /data/torrent/complete
      - type: bind
        source: /mnt/shared/torrent/incomplete                   # ← in-progress downloads
        target: /data/torrent/incomplete
    networks:
      - traefik-net
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 0
      placement:
        constraints:
          - node.labels.media == true
      labels:
        traefik.enable: "true"
        traefik.docker.network: traefik-net

        # HTTPS router to the WebUI (qBittorrent WebUI listens on 8080 by default)
        traefik.http.routers.qb.rule: Host(`qbittorrent.schollar.dev`)
        traefik.http.routers.qb.entrypoints: websecure
        traefik.http.routers.qb.tls.certresolver: cf
        traefik.http.services.qb.loadbalancer.server.port: "8080"

        # Prometheus Blackbox monitoring
        prometheus.blackbox: "true"
        metrics.probe_url: "https://qbittorrent.schollar.dev"

    # Peer ports (for good swarm connectivity). Make sure qBittorrent's
    # Settings → Connections → "Listening Port" matches the published port.
    ports:
      - target: 65283 
        published: 65283
        protocol: tcp
        mode: host
      - target: 65283
        published: 65283
        protocol: udp
        mode: host

volumes:
  qbittorrent_config:
    driver: linbit/linstor-docker-volume
    driver_opts:
      size: 1GB
      fs: "xfs"
      replicas: "2"
      storagepool: "pool_ssd"

networks:
  traefik-net:
    external: true

